# =============================================================
# Default Deny All — Workloads Namespace
# Zero Trust: Assume Breach — no implicit network trust
# =============================================================
# This policy denies ALL ingress and egress traffic by default.
# Individual services must explicitly allow required traffic.
# =============================================================

apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-all
  namespace: workloads
  labels:
    policy-type: baseline
    zero-trust: "true"
spec:
  podSelector: {}  # Applies to ALL pods in namespace
  policyTypes:
    - Ingress
    - Egress
---
# =============================================================
# Allow DNS Resolution (required for all pods)
# Without this, pods cannot resolve any service names
# =============================================================
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-dns
  namespace: workloads
  labels:
    policy-type: baseline
    zero-trust: "true"
spec:
  podSelector: {}
  policyTypes:
    - Egress
  egress:
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53
---
# =============================================================
# Allow Prometheus Scraping (from monitoring namespace)
# =============================================================
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-prometheus-scrape
  namespace: workloads
  labels:
    policy-type: monitoring
    zero-trust: "true"
spec:
  podSelector:
    matchLabels:
      prometheus-scrape: "true"
  policyTypes:
    - Ingress
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: monitoring
      ports:
        - protocol: TCP
          port: 9090   # Prometheus metrics port
        - protocol: TCP
          port: 8080   # Common app metrics port
---
# =============================================================
# Sample: Allow API service traffic
# This is a template — customize for each service
# =============================================================
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-sample-api
  namespace: workloads
  labels:
    policy-type: application
    zero-trust: "true"
spec:
  podSelector:
    matchLabels:
      app: sample-api
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow traffic from ingress controller only
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: ingress
      ports:
        - protocol: TCP
          port: 8080
  egress:
    # Allow DNS
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53
    # Allow Key Vault Private Endpoint (HTTPS)
    - to:
        - ipBlock:
            cidr: 10.2.0.0/16  # Data spoke CIDR
      ports:
        - protocol: TCP
          port: 443
---
# =============================================================
# Default Deny All — Monitoring Namespace
# =============================================================
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-all
  namespace: monitoring
  labels:
    policy-type: baseline
    zero-trust: "true"
spec:
  podSelector: {}
  policyTypes:
    - Ingress
    - Egress
---
# Allow DNS for monitoring namespace
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-dns
  namespace: monitoring
  labels:
    policy-type: baseline
    zero-trust: "true"
spec:
  podSelector: {}
  policyTypes:
    - Egress
  egress:
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53
---
# Allow Prometheus to scrape workloads namespace
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-prometheus-egress
  namespace: monitoring
  labels:
    policy-type: monitoring
    zero-trust: "true"
spec:
  podSelector:
    matchLabels:
      app: prometheus
  policyTypes:
    - Egress
  egress:
    # Scrape workloads namespace
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: workloads
      ports:
        - protocol: TCP
          port: 9090
        - protocol: TCP
          port: 8080
    # Scrape kube-system
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
    # DNS
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53
---
# Allow Grafana to receive ingress (internal access)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-grafana-ingress
  namespace: monitoring
  labels:
    policy-type: monitoring
    zero-trust: "true"
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: grafana
  policyTypes:
    - Ingress
  ingress:
    - ports:
        - protocol: TCP
          port: 3000
---
# =============================================================
# Default Deny All — Ingress Namespace
# =============================================================
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-all
  namespace: ingress
  labels:
    policy-type: baseline
    zero-trust: "true"
spec:
  podSelector: {}
  policyTypes:
    - Ingress
    - Egress
---
# Allow ingress controller (Traefik) to reach workloads
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-ingress-to-workloads
  namespace: ingress
  labels:
    policy-type: application
    zero-trust: "true"
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: traefik
  policyTypes:
    - Egress
  egress:
    # To workloads namespace
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: workloads
      ports:
        - protocol: TCP
          port: 8080
    # DNS
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53
---
# =============================================================
# Default Deny All — Falco System Namespace
# =============================================================
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-all
  namespace: falco-system
  labels:
    policy-type: baseline
    zero-trust: "true"
spec:
  podSelector: {}
  policyTypes:
    - Ingress
    - Egress
---
# Allow DNS for Falco
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-dns
  namespace: falco-system
  labels:
    policy-type: baseline
    zero-trust: "true"
spec:
  podSelector: {}
  policyTypes:
    - Egress
  egress:
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53
---
# Allow Falco to access Kubernetes API and send alerts
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-falco-egress
  namespace: falco-system
  labels:
    policy-type: security
    zero-trust: "true"
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: falco
  policyTypes:
    - Egress
  egress:
    # Allow Kubernetes API access
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: TCP
          port: 443
    # Allow external egress for alerts (HTTPS)
    - to:
        - ipBlock:
            cidr: 0.0.0.0/0
            except:
              - 169.254.169.254/32  # Block Azure metadata service
      ports:
        - protocol: TCP
          port: 443
    # DNS
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53
